<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Price Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation/dist/chartjs-plugin-annotation.min.js"></script>
    
    <!-- SheetJS for .xlsx export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- html2pdf for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons" />
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-color: #ffffff;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --text-primary: #2c3e50;
            --text-secondary: #555;
            --border-color: transparent;
            --header-bg: #f8f9fa;
            --hover-bg: #f5f5f5;
            --primary-color: #4a90e2;
            --separator-color: #ffffff; 
            --group-header-bg: #E0FFFF; /* Light Cyan */
            --group-header-text: #00008B; /* DarkBlue */
            --header-border-thick: 4px solid #999; /* Thick Gray */
            --text-dark-blue: #00008B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            overflow: auto;
            padding: 20px;
        }
        
        .container { 
            display: table;
            margin: 0 auto;
        }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); display: flex;
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 9999; color: white;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2); width: 48px; height: 48px;
            border-radius: 50%; border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .main-content {
            background: var(--bg-color); 
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            display: inline-block; 
            vertical-align: top;
            max-width: 100%;
        }

        #market-cap-tab {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .mc-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            gap: 15px;
            background: #f8f9fa; 
            padding: 8px 10px; 
            border-radius: 8px;
            width: 100%; 
            box-sizing: border-box;
        }
        
        .mc-settings-left { display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .mc-settings-right { display: flex; align-items: center; gap: 8px; margin-left: auto; white-space: nowrap; }
        
        .mc-container {
            background-color: white;
            padding: 0;
            border-radius: 8px;
        }

        .mc-wrapper {
            transform-origin: top left;
            display: block;
            width: 100%;
        }
        
        /* Table Layout */
        .mc-table {
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 1.1rem; 
            table-layout: fixed; 
            width: max-content; 
        }
        .mc-table th, .mc-table td {
            padding: 0 4px; 
            text-align: center; 
            white-space: nowrap;
            height: 30px;
            line-height: 30px;
            border: none !important; 
        }
        
        /* Separator Column (Gap) */
        .col-separator { 
            width: 20px; 
            min-width: 20px; 
            background-color: var(--separator-color) !important; 
            padding: 0 !important;
            border: none !important;
        }

        /* --- Header Styles --- */
        .header-title-row th {
            font-size: 2.4rem;
            color: var(--text-dark-blue);
            background: #fff;
            padding: 5px 0 15px 0;
            font-weight: bold; 
            font-style: italic;
            position: relative; 
            border-bottom: none;
        }
        
        .header-title-row th sup { font-size: 0.4em; vertical-align: super; top: -0.5em; }

        .header-group-row th {
            background-color: var(--group-header-bg);
            color: var(--text-dark-blue);
            font-style: italic;
            font-weight: bold;
            font-size: 1.5rem;
            padding: 8px 0;
            border-top: 1px solid #ffffff;
            border-left: 1px solid #ffffff;
            border-right: 1px solid #a0a0a0;
            border-bottom: 1px solid #a0a0a0;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            outline: 1px solid #ccc;
        }
        .header-group-row th.col-separator {
            background-color: white !important; border: none !important;
            box-shadow: none !important; outline: none !important;
        }

        .header-meta-row th {
            border-bottom: var(--header-border-thick);
            background: #fff;
            font-size: 1.4rem;
            padding: 4px 0;
            color: var(--text-dark-blue);
            font-style: italic;
            font-weight: bold;
            vertical-align: bottom;
        }
        .header-meta-row th.col-separator { border: none !important; }
        .header-meta-row th.no-border-bottom { border-bottom: none !important; }
        .header-meta-row th.border-bottom-thick { border-bottom: var(--header-border-thick) !important; }
        .header-meta-row th.border-right-white { border-right: 12px solid white !important; }
        
        .tsmc-header-big { font-size: 1.1rem !important; }
        .meta-small { font-size: 0.9rem !important; vertical-align: bottom; font-weight: bold; }

        .header-name-row th {
            background: #fff;
            font-size: 1.1rem;
            padding-top: 6px;
            padding-bottom: 4px;
            color: var(--text-dark-blue);
            font-style: italic;
            font-weight: nornal; 
            border-bottom: var(--header-border-thick) !important;
            vertical-align: top;
            white-space: normal; 
            line-height: 1.1;
            height: 40px; 
        }
        .header-name-row th.col-separator { border: none !important; }
        .header-name-row th.date-header {
            color: var(--text-dark-blue) !important; font-style: italic !important; font-weight: normal !important;
        }

        /* Utilities */
        .text-red { color: red !important; }
        .text-italic { font-style: italic; }
        .text-red-italic { color: red !important; font-style: italic; }
        .text-blue-italic { color: var(--text-dark-blue); font-style: italic; }
        .text-black-normal { color: #000 !important; font-style: normal !important; }
        
        .header-note {
            display: block; font-size: 0.75rem; color: #666; font-style: normal; margin-top: 2px;
        }
        .note-red { color: red; }
        .note-red-italic { color: red; font-style: italic; }
        .note-small { font-size: 0.65rem; line-height: 1.0; }
        .note-nowrap { white-space: nowrap !important; }

        .col-date { 
            width: 85px; min-width: 85px; 
            color: #000 !important; font-weight: normal !important; font-style: normal !important;
            text-align: center; background: #fff; 
        }
        .col-data { width: 80px; min-width: 80px; } 
        
        .cell-content {
            display: flex; justify-content: flex-end; align-items: center;
            width: 100%; height: 100%; position: relative; 
        }

        .cell-editable {
            border: none; background: transparent; 
            text-align: right; font-family: 'Segoe UI', sans-serif;
            font-variant-numeric: tabular-nums; font-size: inherit;
            outline: none; cursor: text; flex-grow: 1; padding-right: 2px;
        }
        .cell-editable:focus { background: #e8f0fe; }

        .cell-missing-recent { color: blue; width: 100%; text-align: right; padding-right: 20px; }
        .cell-missing-dash { color: black; width: 100%; text-align: center; padding-right: 16px; }
        .cell-blue { color: blue !important; }

        .indicator-box {
            width: 16px; min-width: 16px; display: flex; justify-content: center; margin-left: 2px;
            position: relative; overflow: visible;
        }

        .triangle-up { color: black; font-size: 0.85rem; }
        .triangle-down { color: black; font-size: 0.85rem; }
        .limit-up { color: black; font-size: 0.85rem; }
        .limit-down { color: black; font-size: 0.85rem; }
        .ex-div-up { color: #008000; font-weight: bold; font-size: 0.85rem; }
        .ex-div-down { color: #d32f2f; font-weight: bold; font-size: 0.85rem; }
        .star-mark { font-size: 0.8rem; position: absolute; left: 100%; top: -2px; width: 12px; }

        .separator-row td {
            border-bottom: 2px solid #ccc !important; 
            height: 5px !important; line-height: 5px !important; padding: 0;
        }
        .separator-row .col-separator { background-color: var(--separator-color) !important; border: none; }

        /* Footnote */
        #footnote-area {
            margin-top: 10px; /* Reduced gap */
            padding: 5px 0;
            border-top: 1px solid #ccc;
            font-size: 0.95rem; line-height: 1.4;
            color: #000; outline: none; white-space: pre-wrap;
            font-family: 'Segoe UI', sans-serif;
            width: 100%;
        }

        .controls-input {
            border: 1px solid #ccc; padding: 4px 8px; border-radius: 4px;
            background-color: white; cursor: pointer; font-size: 0.9rem; width: 100px;
        }
        #mc-as-of-date { padding: 2px 4px; font-size: 0.85rem; width: auto; max-width: 125px; height: 28px; }

        /* Config Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; width: 800px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .config-row { display: grid; grid-template-columns: 30px 100px 150px 150px 50px 60px; gap: 10px; margin-bottom: 10px; align-items: center; }
        .config-row input { padding: 4px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
        .config-header { font-weight: bold; color: #666; margin-bottom: 10px; display: grid; grid-template-columns: 30px 100px 150px 150px 50px 60px; gap: 10px; font-size: 0.85rem; }
        
        .tooltip-container { position: relative; }
        .tooltip-text {
            visibility: hidden; width: 120px; background-color: #555; color: #fff;
            text-align: center; border-radius: 6px; padding: 5px 0;
            position: absolute; z-index: 1; bottom: 100%; left: 50%;
            margin-left: -60px; opacity: 0; transition: opacity 0.3s;
            font-size: 0.75rem;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* PDF Preview Modal */
        #pdf-preview-modal .modal-content { width: 90vw; height: 90vh; display: flex; flex-direction: column; padding: 0; }
        #pdf-frame { flex-grow: 1; width: 100%; border: none; }
        .pdf-toolbar { padding: 10px; background: #eee; display: flex; justify-content: flex-end; gap: 10px; border-bottom: 1px solid #ccc; }

        /* ========================================= */
        /* PDF Styles - Applied to clone only        */
        /* ========================================= */
        .pdf-mode {
            background: white !important;
            padding: 20px !important;
            margin: 0 !important;
            border: none !important;
            box-shadow: none !important;
            width: fit-content !important; 
            min-width: 100%;
            height: auto !important; 
            min-height: 0 !important;
            margin-left: 0 !important; 
            transform: none !important;
            zoom: 1 !important; /* Reset any user zoom */
        }
        .pdf-mode .mc-wrapper {
            width: auto !important;
            overflow: visible !important;
            transform: none !important;
            zoom: 1 !important;
        }
        .pdf-mode .mc-table {
            width: auto !important; /* Let table dictate width */
            margin: 0 !important;
            border-collapse: separate !important; 
            border-spacing: 0 !important;
            table-layout: fixed !important; /* Force fixed layout */
        }
        
        /* [ADJUSTED] Table Cells in PDF */
        .pdf-mode .mc-table th, .pdf-mode .mc-table td {
            /* Fix 1: Optimized padding */
            padding: 0 4px !important; 
            /* Fix 2: Optimized font size */
            font-size: 0.85rem !important; 
            /* Fix 3: Strict height enforcement to prevent jumping rows */
            height: 24px !important; 
            max-height: 24px !important;
            line-height: 24px !important; 
            /* Fix 4: Force no wrap to prevent expansion */
            white-space: nowrap !important; 
            overflow: hidden !important; 
            vertical-align: middle !important; 
            box-sizing: border-box !important;
        }
        
        /* Ensure cell content aligns nicely within the strict height */
        .pdf-mode .cell-content {
            height: 24px !important;
            max-height: 24px !important;
            display: flex !important;
            align-items: center !important;
            overflow: hidden !important;
            white-space: nowrap !important;
        }

        /* Fix for headers */
        .pdf-mode .header-title-row th,
        .pdf-mode .header-group-row th,
        .pdf-mode .header-name-row th {
            height: auto !important;
            max-height: none !important;
            white-space: normal !important;
            overflow: visible !important;
        }

        .pdf-mode .header-title-row th { font-size: 1.6rem !important; padding-bottom: 5px !important; }
        .pdf-mode .header-group-row th { font-size: 1.2rem !important; padding: 6px 0 !important; }
        .pdf-mode .header-name-row th { 
            height: 38px !important; 
            line-height: 1.1 !important; 
            vertical-align: bottom !important;
        }
        
        .pdf-mode tr {
            page-break-inside: avoid;
            height: auto !important;
        }
        
        /* Separator Row Height Fix */
        .pdf-mode .separator-row td {
            height: 1px !important;
            line-height: 0 !important;
            font-size: 0 !important;
            padding: 0 !important;
            border-bottom: 1px solid #999 !important;
            overflow: hidden !important;
        }

        /* [FIX 1] Reduced Separator Width from 12px to 6px to prevent cutoff */
        .pdf-mode .col-separator { 
            width: 6px !important; 
            min-width: 6px !important; 
            max-width: 6px !important;
            padding: 0 !important;
            border: none !important;
        }
        
        /* [FIX 1] Slightly reduced min-width to fit A4 */
        .pdf-mode .col-data { min-width: 58px !important; }
        .pdf-mode .col-date { min-width: 75px !important; }
        
        /* [FIX 4] Footnote: Increased font size */
        .pdf-mode #footnote-area { 
            margin-top: 15px !important; 
            padding-bottom: 0 !important;
            font-size: 0.9rem !important; 
            line-height: 1.25 !important;
            border-top: 1px solid #000 !important;
            white-space: pre-wrap !important; 
            display: block !important;
            height: auto !important;
            width: 100% !important;
            overflow: visible !important;
        }
        /* Hide UI elements in PDF */
        .pdf-mode .mc-header, .pdf-mode .mc-settings-left, .pdf-mode .mc-settings-right { display: none !important; }

        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; margin: 0; padding: 0; }
            .container { max-width: none; width: 100%; margin: 0; padding: 0; display: block; }
            .header-bar, .mc-header, #loading-overlay, .modal-overlay { display: none !important; }
            .main-content, .mc-container { box-shadow: none; padding: 0; margin: 0; border: none; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top:20px;">Loading Market Data...</p>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">Configuration</h3>
            <div class="config-header">
                <span>#</span>
                <span>Ticker ID</span>
                <span>Name (Row 3)</span>
                <span>Note (Row 3)</span>
                <span>Dec</span>
                <span>Footnote#</span>
            </div>
            <div id="config-list"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeConfig()" style="padding: 5px 15px; cursor: pointer; background: #4a90e2; color: white; border: none; border-radius: 4px;">Close & Apply</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="pdf-toolbar">
                <button onclick="downloadPDF()" class="controls-input" style="background:#4a90e2; color:white; border:none;">Download</button>
                <button onclick="printPDF()" class="controls-input">Print</button>
                <button onclick="closePDF()" class="controls-input">Close</button>
            </div>
            <iframe id="pdf-frame"></iframe>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div id="market-cap-tab">
                <div class="mc-header">
                    <div class="mc-settings-left">
                        <label>As of:</label>
                        <input type="date" id="mc-as-of-date" class="controls-input" onchange="renderTable()">
                        <button class="controls-input" onclick="openConfig()" style="width: auto;"><i class="material-icons" style="font-size:14px; vertical-align:middle;">settings</i> Config</button>
                    </div>
                    
                    <div class="mc-settings-right">
                        <button class="controls-input" onclick="zoomTable(0.05)" style="width:40px; text-align:center;"><i class="material-icons" style="font-size:16px;">add</i></button>
                        <button class="controls-input" onclick="zoomTable(-0.05)" style="width:40px; text-align:center;"><i class="material-icons" style="font-size:16px;">remove</i></button>
                        <button class="controls-input" onclick="openPDF()" style="width:auto;"><i class="material-icons" style="font-size:16px; vertical-align:text-bottom;">picture_as_pdf</i> PDF</button>
                    </div>
                </div>

                <div class="page-title"></div>

                <div class="mc-container">
                    <div class="mc-wrapper" id="mc-wrapper">
                        <div class="mc-grid-top" id="mc-grid"></div>
                        <div id="footnote-area" contenteditable="true">Source: Yahoo Finance</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        let COLUMN_CONFIG = [
            // TAIEX Group
            { id: '.TWII', row2: '', row2Class:'border-bottom-thick border-right-white', name: 'Index', note: '', group: 'TAIEX', noArrow: true, metaClass:'border-right-white' },
            { id: '2330.TW', row2: 'TSMC', name: 'Close', note: '', group: 'TAIEX', fixedDecimals: 1 },
            { id: '2330.TW', row2: 'TSMC', name: 'Volume', note: '', group: 'TAIEX', type: 'volume', noArrow: true, isMergedHelper: true }, 
            { id: 'TWD=', row2: '', row2Class: 'no-border-bottom', name: 'USD/NTD', note: '11:00 Fixing', group: 'TAIEX', type: 'fx', noArrow: true },

            { type: 'separator' },

            // Big Group
            { id: 'TSM', row2: 'Closing', name: 'TSM', note: '', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'PREMIUM', row2: 'Closing', name: 'Premium', note: '(CBC Rate)', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR', type: 'calc', noArrow: true },
            { id: '2308.TW', row2: 'Closing', name: 'Delta', note: '(2308)', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' }, 
            { id: '2454.TW', row2: 'Closing', name: 'MTK', note: '(2454)', noteClass:'text-red-italic', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: '2317.TW', row2: 'Closing', name: 'Hon Hai', note: '(2317)', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'NVDA', row2: 'Closing', name: 'NVDA', note: '', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'GOOGL', row2: 'Closing', name: 'GOOGL', note: '', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'AAPL', row2: 'Closing', name: 'AAPL', note: '', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'MSFT', row2: 'Closing', name: 'MSFT', note: '', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'AMZN', row2: 'Closing', name: 'AMZN', note: '', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'META', row2: 'Closing', name: 'META', note: '', noteId: '3', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'AVGO', row2: 'Closing', name: 'AVGO', note: '', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'TSLA', row2: 'Closing', name: 'TSLA', note: '', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: '005930.KS', row2: 'Closing', name: 'Samsung', note: '(KRW)', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },
            { id: 'ASML.AS', row2: 'Closing', name: 'ASML', note: '(EUR)', noteClass: 'text-red', group: 'TAIEX/NYSE/NASDAQ/HKEX/KSE/STAR' },

            { type: 'separator' },

            // Indices Group
            { id: '.IXIC', row2: 'Closing', name: 'Nasdaq', note: '', group: 'Indices' },
            { id: '.SOX', row2: 'Closing', name: 'SOX', note: '', group: 'Indices' },
            { id: '.MCI', row2: 'Closing', name: 'Mag7', note: '', noteId: '4', group: 'Indices', type: 'mci', fixedDecimals: 2 }
        ];

        let dataByTicker = {};
        let eventsData = {};
        let summaryReferenceDate = new Date();
        let zoomLevel = 1.0;
        let columnDecimalRules = {}; 
        
        let tsmExDivInfo = null;
        let tsmAccumDiv = 0;
        let splitInfoStr = "";
        let pdfBlobUrl = null;

        const START_STATS_DATE = new Date('2009-06-12').getTime();
        const START_DIV_DATE = new Date('2008-01-01').getTime();
        
        const TICKER_NAMES = {
            '2330.TW': 'TSMC', '2308.TW': 'Delta', '2454.TW': 'MediaTek', '2317.TW': 'Hon Hai',
            'NVDA': 'NVIDIA', 'GOOGL': 'Alphabet', 'AAPL': 'Apple', 'MSFT': 'Microsoft',
            'AMZN': 'Amazon', 'META': 'Meta Platforms', 'AVGO': 'Broadcom', 'TSLA': 'Tesla',
            '005930.KS': 'Samsung Elec', 'ASML.AS': 'ASML', '.IXIC': 'Nasdaq Composite',
            '.SOX': 'PHLX Semi', '.TWII': 'TAIEX'
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            if(window.innerWidth < 1600) zoomLevel = 0.85;
            lse zoomLevel = 1.1;
            applyZoom();
        });

        async function loadData() {
            const urls = [
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/Equity_Index.json',
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/TW_Stocks.json',
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/US_Stocks.json',
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/custom_index.json',
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/FX.json',
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/events.json'
            ];

            try {
                const results = await Promise.all(urls.map(u => fetch(u).then(r => r.ok ? r.json() : null)));
                
                results.forEach((json, idx) => {
                    if(!json) return;
                    const isMCI = idx === 3;
                    const isFX = idx === 4;
                    const isEvents = idx === 5;
                    
                    if(isEvents) {
                        eventsData = json; 
                    } else if (isMCI) {
                        // Ignore
                    } else if (isFX) {
                         if(json['TWD=']) processTickerData('TWD=', json['TWD=']);
                         if(json['TWD=X']) processTickerData('TWD=X', json['TWD=X']);
                    } else {
                        Object.entries(json).forEach(([t, d]) => processTickerData(t, d));
                    }
                });
                
                calculateMag7();
                calculateTSMCStats();
                calculateSplitStats();

                let maxTs = 0;
                if(dataByTicker['2330.TW'] && dataByTicker['2330.TW'].length) {
                     maxTs = dataByTicker['2330.TW'][dataByTicker['2330.TW'].length-1].date.getTime();
                } 
                
                summaryReferenceDate = new Date(maxTs);
                document.getElementById('mc-as-of-date').value = summaryReferenceDate.toISOString().split('T')[0];
                document.getElementById('loading-overlay').style.display = 'none';
                
                renderFootnotes();
                renderTable();

            } catch(e) {
                console.error(e);
                document.getElementById('loading-text').innerText = "Error loading data.";
            }
        }

        function processTickerData(rawTicker, data) {
            if(!data || !data.date || !data.close) return;
            
            let ticker = rawTicker;
            if (ticker.endsWith('.O') || ticker.endsWith('.N')) ticker = ticker.split('.')[0];
            if (ticker === 'TSM.N') ticker = 'TSM';
            if (ticker === '0059.KS') ticker = '005930.KS'; 

            const clean = [];
            const dates = data.date;
            const prices = data.close;
            const vols = data.volume || [];

            for(let i=0; i<dates.length; i++) {
                const dStr = dates[i];
                if(dStr.includes('T') || dStr.includes(' ')) continue; 
                
                const p = prices[i];
                if(p == null) continue;
                
                clean.push({
                    date: new Date(dStr),
                    dateStr: dStr, 
                    price: p,
                    volume: vols[i] || 0
                });
            }
            if(!dataByTicker[ticker]) dataByTicker[ticker] = clean;
        }

        function calculateMag7() {
            const tickers = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA'];
            
            let dateSet = new Set();
            tickers.forEach(t => {
                if(dataByTicker[t]) dataByTicker[t].forEach(d => dateSet.add(d.date.getTime()));
            });
            let dates = Array.from(dateSet).sort((a,b) => a-b);
            
            if(dates.length === 0) return;

            const baseDate = new Date('2009-06-12').getTime();
            let mciData = [];
            let startIdx = dates.findIndex(d => d >= baseDate);
            if(startIdx === -1) startIdx = 0;
            
            let currentIndex = 100;
            
            mciData.push({ 
                date: new Date(dates[startIdx]), 
                dateStr: new Date(dates[startIdx]).toISOString().split('T')[0], 
                price: 100 
            });

            for(let i = startIdx + 1; i < dates.length; i++) {
                const dTime = dates[i];
                let dailySumRet = 0;
                let count = 0;

                tickers.forEach(t => {
                    const arr = dataByTicker[t];
                    if(!arr) return;
                    
                    const currPt = arr.find(d => d.date.getTime() === dTime);
                    if(currPt) {
                         const idx = arr.indexOf(currPt);
                         if(idx > 0) {
                             const prevPt = arr[idx-1];
                             const ret = (currPt.price / prevPt.price) - 1;
                             dailySumRet += ret;
                             count++;
                         }
                    }
                });

                if(count > 0) {
                    const avgRet = dailySumRet / count; 
                    currentIndex = currentIndex * (1 + avgRet);
                }
                
                mciData.push({ 
                    date: new Date(dTime), 
                    dateStr: new Date(dTime).toISOString().split('T')[0],
                    price: currentIndex
                });
            }
            
            dataByTicker['.MCI'] = mciData;
        }

        function normalizeTicker(t) {
            if(!t) return '';
            if(t.indexOf('.') > -1 && !t.endsWith('.TW') && !t.endsWith('.TWO') && !t.endsWith('.KS') && !t.endsWith('.HK') && !t.endsWith('.SS') && !t.startsWith('.')) {
                return t.split('.')[0];
            }
            return t;
        }

        function findEventsForTicker(tickerId) {
            if(eventsData[tickerId]) return eventsData[tickerId];
            const norm = normalizeTicker(tickerId);
            const keys = Object.keys(eventsData);
            for(let k of keys) {
                if(normalizeTicker(k) === norm) return eventsData[k];
            }
            return { events: [] };
        }

        function getPriceOnDate(ticker, dateObj) {
            const data = dataByTicker[ticker];
            if(!data) return null;
            const targetTime = dateObj.getTime();
            const pt = data.find(d => d.date.getTime() === targetTime);
            if(pt) return pt.price;
            return null;
        }
        
        function getPrevCloseForDate(ticker, dateObj) {
            const data = dataByTicker[ticker];
            if(!data) return null;
            const targetTime = dateObj.getTime();
            const idx = data.findIndex(d => d.date.getTime() >= targetTime);
            if(idx > 0) return data[idx-1].price;
            return null;
        }

        function calculateTSMCStats() {
            const eventsTW = findEventsForTicker('2330.TW');
            const eventsUS = findEventsForTicker('TSM');
            
            let twInfo = '';
            let usInfo = '';
            
            if(eventsTW && eventsTW.events) {
                const sorted = [...eventsTW.events].filter(e => e.type === 'dividend').sort((a,b) => new Date(b.date) - new Date(a.date));
                if(sorted.length > 0) {
                    const ev = sorted[0];
                    const d = new Date(ev.date);
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const yy = String(d.getFullYear()).slice(-2);
                    
                    const prevClose = getPrevCloseForDate('2330.TW', d);
                    const exRef = prevClose ? (prevClose - ev.amount).toFixed(1) : '-';
                    
                    twInfo = `TSMC ex-dividend date ${m}/${day}/'${yy} (Ex-Div Ref NT$ ${exRef})`;
                }
            }
            
            if(eventsUS && eventsUS.events) {
                const sorted = [...eventsUS.events].filter(e => e.type === 'dividend').sort((a,b) => new Date(b.date) - new Date(a.date));
                if(sorted.length > 0) {
                    const ev = sorted[0];
                    const d = new Date(ev.date);
                    
                    const prevClose = getPrevCloseForDate('TSM', d);
                    const exRef = prevClose ? (prevClose - ev.amount).toFixed(2) : '-';
                    
                    usInfo = `TSM (Ex-Div Ref US$ ${exRef})`;
                }
            }
            
            if(twInfo) {
                tsmExDivInfo = `<span style="color:red;">(1) ☆ indicates ex-dividend date (${twInfo}${usInfo ? '; ' + usInfo : ''})</span>`;
            } else {
                tsmExDivInfo = '<span style="color:red;">(1) ☆ indicates ex-dividend date (TSMC ex-dividend date -)</span>';
            }

            let accum = 0;
            if(eventsTW && eventsTW.events) {
                eventsTW.events.forEach(e => {
                    if(e.type === 'dividend' && new Date(e.date).getTime() >= START_DIV_DATE) {
                        accum += e.amount;
                    }
                });
            }
            tsmAccumDiv = accum.toFixed(2);
        }

        function calculateSplitStats() {
            let splitTextArr = [];
            let tickersToCheck = new Set();
            COLUMN_CONFIG.forEach(col => {
                if(col.id && !col.id.startsWith('.') && col.id !== 'PREMIUM' && col.id !== '2330.TW' && col.id !== 'TSM') tickersToCheck.add(col.id);
            });

            tickersToCheck.forEach(tid => {
                const events = findEventsForTicker(tid);
                if(events && events.events) {
                    const splits = events.events.filter(e => e.type === 'split' && new Date(e.date).getTime() >= START_STATS_DATE);
                    splits.sort((a, b) => new Date(a.date) - new Date(b.date)); 

                    let tickerSplits = [];
                    splits.forEach(s => {
                        let ratio = s.numerator / s.denominator;
                        let ratioStr = parseFloat(ratio.toFixed(4)) + ":1";
                        const yr = new Date(s.date).getFullYear();
                        tickerSplits.push(`${ratioStr} (${yr})`);
                    });
                    
                    if(tickerSplits.length > 0) {
                        let displayTicker = events.name || normalizeTicker(tid);
                        const cfg = COLUMN_CONFIG.find(c => c.id === tid);
                        if(cfg && cfg.name) displayTicker = cfg.name.replace(/<[^>]*>?/gm, '').split('<')[0].trim();
                        splitTextArr.push(`${displayTicker} - ${tickerSplits.join(', ')}`);
                    }
                }
            });
            
            if(splitTextArr.length > 0) {
                splitInfoStr = "(5) Stock split record since 06/12/'09: " + splitTextArr.join('; ');
            } else {
                splitInfoStr = "(5) Stock split record since 06/12/'09: -";
            }
        }

        function renderFootnotes() {
            const area = document.getElementById('footnote-area');
            let divInfo = `(2) TSMC accumulated dividend per share since 2008: ${tsmAccumDiv}`;
            
            area.innerHTML = `Source: Yahoo Finance
${tsmExDivInfo}
${divInfo}
(3) Meta IPO: NASDAQ, May 18, 2012, $38.00
(4) Mag7: Equal Weight of AAPL, MSFT, GOOGL, AMZN, NVDA, META, TSLA (Base 100 at 06/12/'09)
${splitInfoStr}`;
        }

        function getTableDates(anchor) {
            const refTicker = '2330.TW';
            const data = dataByTicker[refTicker] || [];
            const anchorTime = anchor.getTime();
            
            let recent = [];
            if(data.length) {
                recent = data.filter(d => d.date.getTime() <= anchorTime).slice(-19).map(d => d.date).reverse();
            }
            
            const history = [];
            let exDivDate = null;
            const tsmEvents = findEventsForTicker('2330.TW');
            if(tsmEvents && tsmEvents.events) {
                 const evs = tsmEvents.events.filter(e => e.type === 'dividend');
                 const sortedEvs = evs.sort((a,b) => new Date(b.date) - new Date(a.date));
                 const lastEv = sortedEvs.find(e => new Date(e.date).getTime() <= anchorTime);
                 if(lastEv) exDivDate = new Date(lastEv.date);
            }
            if(exDivDate) history.push(exDivDate);

            const mandatoryDates = ['2019-01-02', '2018-01-02', '2017-01-03', '2016-01-04', '2015-01-05', '2014-01-02', '2013-01-02'];
            const currentYear = anchor.getFullYear();
            for(let y = currentYear - 1; y >= 2020; y--) {
                const firstDay = data.find(d => d.date.getFullYear() === y);
                if(firstDay && firstDay.date.getTime() <= anchorTime) history.push(firstDay.date);
            }
            mandatoryDates.forEach(dStr => {
                const targetD = new Date(dStr);
                if(!history.find(h => h.getTime() === targetD.getTime())) history.push(targetD);
            });
            history.sort((a,b) => b.getTime() - a.getTime());
            history.push(new Date('2009-06-12'));
            return { recent, history };
        }

        function getDataPoint(ticker, date) {
            const arr = dataByTicker[ticker];
            if(!arr) return null;
            const dTime = date.getTime();
            return arr.find(d => d.date.getTime() === dTime) || null;
        }
        
        function getPrevDataPoint(ticker, date) {
            const arr = dataByTicker[ticker];
            if(!arr) return null;
            const dTime = date.getTime();
            const idx = arr.findIndex(d => d.date.getTime() === dTime);
            if(idx > 0) return arr[idx-1];
            return null;
        }

        function formatDisplayDate(date) {
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const yy = String(date.getFullYear()).slice(-2);
            return `${m}/${d}/'${yy}`;
        }

        function calculateDecimalRules(allDates) {
            COLUMN_CONFIG.forEach((col, idx) => {
                if(col.type === 'separator' || col.type === 'calc' || col.type === 'fx' || col.type === 'volume') return;
                let maxP = 0;
                allDates.forEach(d => {
                    const pt = getDataPoint(col.id, d);
                    if(pt && pt.price > maxP) maxP = pt.price;
                });
                if((col.id.endsWith('.TW') || col.id.endsWith('.TWO')) && !col.id.startsWith('.')) {
                    if (maxP >= 1000) columnDecimalRules[idx] = 0;
                    else if (maxP >= 100) columnDecimalRules[idx] = 1;
                    else columnDecimalRules[idx] = 2;
                } else if (col.id === '.MCI') {
                    columnDecimalRules[idx] = 2;
                } else {
                    columnDecimalRules[idx] = 2;
                }
            });
        }

        function formatVal(col, pt, colIdx) {
            if(!pt) return { text: '', html: '' };
            if(col.type === 'volume') {
                const v = pt.volume / 1000;
                return { text: v.toLocaleString('en-US', { maximumFractionDigits: 0 }), html: v.toLocaleString('en-US', { maximumFractionDigits: 0 }) };
            }
            if(col.type === 'fx') {
                const txt = pt.price.toFixed(2);
                return { text: txt, html: txt };
            }
            const price = pt.price;
            let decimals = col.fixedDecimals; 
            if (decimals === undefined) {
                 if(col.id.endsWith('.T') || col.id.endsWith('.KS')) decimals = 0;
                 else {
                     decimals = columnDecimalRules[colIdx];
                     if(decimals === undefined) decimals = 2;
                 }
            }
            const txt = price.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return { text: txt, html: txt };
        }

        function getPremium(date) {
            const tsm = getDataPoint('TSM', date);
            const tw = getDataPoint('2330.TW', date);
            let fx = getDataPoint('TWD=', date) || getDataPoint('TWD=X', date);
            const hasTSM = (tsm && tsm.price > 0);
            const hasTW = (tw && tw.price > 0);
            
            if (!hasTSM && !hasTW) return { text: '', html: '' };
            if (!hasTSM || !hasTW) return { text: 'N/A', html: '<span class="cell-blue">N/A</span>' };
            if (!fx || fx.price === 0) return { text: 'N/A', html: '<span class="cell-blue">N/A</span>' };
            
            const adrVal = tsm.price / 5;
            const twValUSD = tw.price / fx.price;
            const premium = (adrVal / twValUSD) - 1;
            const txt = (premium * 100).toFixed(1) + '%';
            return { text: txt, html: txt };
        }

        // --- Config Modal ---
        function openConfig() {
            const list = document.getElementById('config-list');
            list.innerHTML = '';
            COLUMN_CONFIG.forEach((col, idx) => {
                if(col.type === 'separator') return;
                const div = document.createElement('div');
                div.className = 'config-row';
                div.innerHTML = `<span style="font-size:0.8rem; color:#999; margin-right:5px; width:20px;">${idx+1}</span>`;
                div.innerHTML += `<div class="tooltip-container"><input type="text" value="${col.id}" id="cfg-id-${idx}" style="width:100px;" placeholder="Ticker ID"><span class="tooltip-text">${TICKER_NAMES[col.id] || col.id}</span></div>`;
                div.innerHTML += `<input type="text" placeholder="Name" value="${col.name}" id="cfg-name-${idx}" style="width:150px;">`;
                div.innerHTML += `<input type="text" placeholder="Note" value="${col.note || ''}" id="cfg-note-${idx}" style="width:80px;">`;
                if(col.type !== 'volume' && col.type !== 'calc') {
                    div.innerHTML += `<input type="number" placeholder="Dec" value="${col.fixedDecimals !== undefined ? col.fixedDecimals : ''}" id="cfg-dec-${idx}" style="width:50px;">`;
                } else {
                    div.innerHTML += `<span></span>`;
                }
                 div.innerHTML += `<input type="text" placeholder="FN#" value="${col.noteId || ''}" id="cfg-nid-${idx}" style="width:40px;">`;
                list.appendChild(div);
            });
            document.getElementById('config-modal').style.display = 'flex';
        }

        function closeConfig() {
            COLUMN_CONFIG.forEach((col, idx) => {
                if(col.type === 'separator') return;
                const idIn = document.getElementById(`cfg-id-${idx}`);
                const nameIn = document.getElementById(`cfg-name-${idx}`);
                const noteIn = document.getElementById(`cfg-note-${idx}`);
                const decIn = document.getElementById(`cfg-dec-${idx}`);
                const nidIn = document.getElementById(`cfg-nid-${idx}`);
                
                if(idIn) col.id = idIn.value;
                if(nameIn) col.name = nameIn.value;
                if(noteIn) col.note = noteIn.value;
                if(nidIn) col.noteId = nidIn.value;
                if(decIn) {
                    const val = decIn.value;
                    if(val === '') delete col.fixedDecimals;
                    else col.fixedDecimals = parseInt(val);
                }
            });
            document.getElementById('config-modal').style.display = 'none';
            renderTable();
        }
        
        // --- PDF Generation (Optimized for One Page Fit) ---
        function openPDF() {
            // Logic to Fit One Page A4 Landscape perfectly
            const originalElement = document.getElementById('market-cap-tab');
            const clone = originalElement.cloneNode(true);
            
            // Apply PDF-specific optimizations to the clone
            clone.id = "pdf-clone-content";
            clone.classList.add('pdf-mode');
            
            // Fix: Reset transform/zoom on the wrapper inside the clone
            const wrapper = clone.querySelector('#mc-wrapper');
            if(wrapper) {
                wrapper.style.transform = 'none';
                wrapper.style.zoom = '1';
                wrapper.style.width = '100%';
            }

            // Remove controls from clone
            const controls = clone.querySelector('.mc-header');
            if(controls) controls.style.display = 'none';
            
            // Create a temporary container - keep it visible but positioned off-screen
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.top = '-10000px'; 
            container.style.left = '0';
            // Allow container to fit the content naturally first
            container.style.width = 'fit-content';
            container.style.visibility = 'hidden';
            
            container.appendChild(clone);
            document.body.appendChild(container);

            // Wait for DOM to calculate widths
            setTimeout(() => {
                // Find the table inside the clone to get exact dimensions
                const table = clone.querySelector('.mc-table');
                // Use the table's actual rendered width (scrolling width)
                // This ensures we capture the FULL table width, preventing whitespace if container was wider
                // or preventing clipping if container was narrower.
                const tableWidth = table ? table.scrollWidth : clone.scrollWidth;
                const tableHeight = clone.scrollHeight;
                
                // Add a small buffer only for borders
                const finalWidth = tableWidth + 50; 
                const finalHeight = tableHeight + 5; // Reduced buffer for footer

                const opt = {
                    margin: [5, 5, 5, 5], // Reduced margins
                    filename: 'Stock_Price_Monitor.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true,
                        scrollY: 0,
                        scrollX: 0,
                        // STRICTLY set the canvas size to the content size
                        windowWidth: finalWidth, 
                        windowHeight: finalHeight,
                        width: finalWidth,
                        height: finalHeight
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'landscape',
                        compress: true
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                // Direct html2pdf usage
                html2pdf().set(opt).from(clone).toPdf().get('pdf').then(function(pdf) {
                    pdfBlobUrl = pdf.output('bloburl');
                    document.getElementById('pdf-frame').src = pdfBlobUrl;
                    document.getElementById('pdf-preview-modal').style.display = 'flex';
                    document.body.removeChild(container);
                }).catch(err => {
                    console.error("PDF Generation Error:", err);
                    alert("PDF Generation failed. Please try again.");
                    if(document.body.contains(container)) document.body.removeChild(container);
                });
            }, 300);
        }

        function downloadPDF() {
            if(!pdfBlobUrl) return;
            const link = document.createElement('a');
            link.href = pdfBlobUrl;
            link.download = "Stock_Price_Monitor.pdf";
            link.click();
        }

        function printPDF() {
            const iframe = document.getElementById('pdf-frame');
            if (iframe.contentWindow) {
                iframe.contentWindow.print();
            }
        }

        function closePDF() {
            document.getElementById('pdf-preview-modal').style.display = 'none';
        }

        // --- Rendering ---
        function renderTable() {
            const container = document.getElementById('mc-grid');
            container.innerHTML = '';
            
            const dateInput = document.getElementById('mc-as-of-date').value;
            const anchor = dateInput ? new Date(dateInput) : summaryReferenceDate;
            const { recent, history } = getTableDates(anchor);
            const allDates = [...recent, ...history];

            calculateDecimalRules(allDates);

            const block = document.createElement('div');
            block.className = 'mc-block';
            let html = `<table class="mc-table">`;
            
            // Row 0: Title
            html += `<tr class="header-title-row">`;
            let groups = [];
            let currentGroup = null;
            if(COLUMN_CONFIG[0].group === 'TAIEX') currentGroup = { name: 'TAIEX', span: 1 }; 
            else { html += `<th></th>`; currentGroup = null; }

            COLUMN_CONFIG.forEach(col => {
                if(col.type === 'separator') {
                     if(currentGroup) groups.push(currentGroup);
                     groups.push({ type: 'separator' });
                     currentGroup = null;
                } else {
                    if(col.isMergedHelper) {
                        if(currentGroup) currentGroup.span++;
                    } else {
                        if(!currentGroup || currentGroup.name !== col.group) {
                            if(currentGroup) groups.push(currentGroup);
                            currentGroup = { name: col.group, span: 0 };
                        }
                        currentGroup.span++;
                    }
                }
            });
            if(currentGroup) groups.push(currentGroup);
            
            groups.forEach((g, idx) => {
                if(g.type === 'separator') html += `<th class="col-separator"></th>`;
                else {
                    if(idx === 2) html += `<th colspan="${g.span}">Stock Price<sup>(2)</sup></th>`;
                    else html += `<th colspan="${g.span}"></th>`;
                }
            });
            html += `</tr>`;

            // Row 1: Groups
            html += `<tr class="header-group-row">`;
            groups.forEach(g => {
                if(g.type === 'separator') html += `<th class="col-separator"></th>`;
                else html += `<th colspan="${g.span}">${g.name}</th>`;
            });
            html += `</tr>`;

            // Row 2: Meta
            html += `<tr class="header-meta-row"><th class="col-date no-border-bottom"></th>`; 
            for(let i=0; i<COLUMN_CONFIG.length; i++) {
                let col = COLUMN_CONFIG[i];
                if(col.type === 'separator') {
                    html += `<th class="col-separator"></th>`;
                } else if(col.group === 'TAIEX') {
                    if(col.id === '2330.TW' && !col.isMergedHelper) {
                        html += `<th class="col-data tsmc-header-big text-blue-italic border-bottom-thick" colspan="2">TSMC</th>`;
                        i++; 
                    } else if (col.id === 'TWD=') {
                        html += `<th class="col-data no-border-bottom"></th>`;
                    } else if (col.id === '.TWII') {
                        html += `<th class="col-data border-bottom-thick border-right-white"></th>`;
                    }
                } else {
                    let isStart = (i === 0 || COLUMN_CONFIG[i-1].type === 'separator' || COLUMN_CONFIG[i-1].group !== col.group);
                    if(isStart) {
                        let span = 0;
                        for(let k=i; k<COLUMN_CONFIG.length; k++) {
                            if(COLUMN_CONFIG[k].group === col.group && COLUMN_CONFIG[k].type !== 'separator') span++;
                            else break;
                        }
                        html += `<th class="col-data text-blue-italic border-bottom-thick" colspan="${span}">Closing</th>`;
                        i += (span - 1);
                    }
                }
            }
            html += `</tr>`;

            // Row 3: Name + Note Merged (Header Row)
            html += `<tr class="header-name-row"><th class="col-date date-header text-blue-italic" style="color:var(--text-dark-blue); font-style:italic; font-weight:normal;">Date<sup>&nbsp;</sup></th>`;
            COLUMN_CONFIG.forEach(col => {
                if(col.type === 'separator') {
                    html += `<th class="col-separator"></th>`;
                } else {
                    let content = col.name; 
                    if(col.noteId) content += `<sup>(${col.noteId})</sup>`;
                    // Ensure spacing for superscripts even if no noteId
                    if(!col.noteId) content += `<sup>&nbsp;</sup>`;
                    
                    if(col.note) {
                        let noteCls = col.noteClass ? col.noteClass : 'note-red';
                        let nText = col.note;
                        content += `<br><span class="header-note ${noteCls}">${nText}</span>`;
                    } else {
                        // Empty note spacer to align height
                        content += `<br><span class="header-note">&nbsp;</span>`;
                    }
                    if(col.nameClass) {
                        html += `<th class="col-data text-blue-italic ${col.nameClass}">${content}</th>`;
                    } else {
                        html += `<th class="col-data text-blue-italic">${content}</th>`;
                    }
                }
            });
            html += `</tr>`;
            
            // Data Rows
            const renderRow = (date, isRecent) => {
                const rowDateStr = date.toISOString().split('T')[0];
                let rowHtml = `<tr>`;
                rowHtml += `<td class="col-date">${formatDisplayDate(date)}</td>`;
                
                COLUMN_CONFIG.forEach((col, colIdx) => {
                    if(col.type === 'separator') {
                        rowHtml += `<td class="col-separator"></td>`;
                        return;
                    }

                    let display = { text: '', html: '' };
                    let symbolHtml = '';
                    let isDividendDay = false;

                    const events = findEventsForTicker(col.id);
                    if(events && events.events) {
                         const divEv = events.events.find(e => e.type === 'dividend' && e.date === rowDateStr);
                         if(divEv) isDividendDay = true;
                    }
                    
                    if(col.id === 'PREMIUM') {
                        display = getPremium(date);
                    } else {
                        let key = col.id;
                        if(key === 'TWD=' && !dataByTicker['TWD=']) key = 'TWD=X';
                        
                        const pt = getDataPoint(key, date);
                        display = formatVal(col, pt, colIdx);
                        
                        if(pt && !col.noArrow) {
                            const prevPt = getPrevDataPoint(key, date);
                            if(prevPt) {
                                const changePct = (pt.price / prevPt.price) - 1;
                                
                                if(changePct > 0) {
                                    if(Math.abs(changePct) > 0.098 && (col.id.endsWith('.TW') || col.id.endsWith('.TWO'))) {
                                        symbolHtml = '<span class="limit-up">▲</span>'; 
                                    } else if (isDividendDay) {
                                        symbolHtml = '<span class="ex-div-up">△</span><span class="ex-div-up star-mark">☆</span>';
                                    } else {
                                        symbolHtml = '<span class="triangle-up">△</span>';
                                    }
                                } else if (changePct < 0) {
                                    if(Math.abs(changePct) > 0.098 && (col.id.endsWith('.TW') || col.id.endsWith('.TWO'))) {
                                        symbolHtml = '<span class="limit-down">▼</span>';
                                    } else if (isDividendDay) {
                                        symbolHtml = '<span class="ex-div-down">▽</span><span class="ex-div-down star-mark">☆</span>';
                                    } else {
                                        symbolHtml = '<span class="triangle-down">▽</span>';
                                    }
                                }
                            }
                        }
                    }
                    
                    if(col.noArrow) symbolHtml = '';

                    if(display.text === '' || display.text === '-') {
                        if(col.id === '.MCI' || col.id === 'PREMIUM') {
                             rowHtml += `<td><div class="cell-missing-dash">${display.html || '-'}</div></td>`;
                        } else if(isRecent) {
                            rowHtml += `<td><div class="cell-missing-recent">Close</div></td>`;
                        } else {
                            rowHtml += `<td></td>`; 
                        }
                    } else {
                        rowHtml += `<td>
                            <div class="cell-content">
                                <div class="cell-editable" contenteditable="true">${display.html}</div>
                                <div class="indicator-box">${symbolHtml}</div>
                            </div>
                        </td>`;
                    }
                });
                rowHtml += `</tr>`;
                return rowHtml;
            };

            recent.forEach(d => {
                html += renderRow(d, true);
            });

            html += `<tr class="separator-row"><td colspan="${COLUMN_CONFIG.length + 5}"></td></tr>`;

            history.forEach(d => {
                html += renderRow(d, false);
            });

            html += `</table>`;
            block.innerHTML = html;
            container.appendChild(block);
        }

        function zoomTable(delta) {
            zoomLevel += delta;
            if(zoomLevel < 0.2) zoomLevel = 0.2;
            if(zoomLevel > 2.0) zoomLevel = 2.0;
            applyZoom();
        }
        
        function applyZoom() {
            const wrapper = document.getElementById('mc-wrapper');
            // When zooming, we want the origin to be top-left so it stays aligned
            if(wrapper) {
                // Switch to using zoom style for layout-friendly scaling
                wrapper.style.zoom = zoomLevel;
            }
        }
    </script>
</body>
</html>
